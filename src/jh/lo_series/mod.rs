use num_complex::{Complex, Complex64};

use crate::{
    const_value::{C0, C1, I}, res::{Res, FC64, NUM}, series::local_solution::{poly::PolyCal, ZeroIn, ZeroOut}
};
use super::local_solution::Para;
macro_rules! cpsez {
    ($o:ident,$($i:expr),*) => {
        cpsez!($($i),* ; c0,c2,c3,c4,c5,c6,c7,c8,c9 ; on($o, 0.),on($o, 2.),on($o, 3.),on($o, 4.),on($o, 5.),on($o, 6.),on($o, 7.),on($o, 8.),on($o, 9.) ; on($o, 0.),on($o, -2.),on($o, -3.),on($o, -4.),on($o, -5.),on($o, -6.),on($o, -7.),on($o, -8.),on($o, -9.))
    };

    ($($expr:expr),* ; $($c:ident),* ; $($op:expr),* ; $($om:expr),*) => {
        {
            dc!($($expr),*;$($c),*);
            (co!($($expr),*;$($c),*;$($op),*),co!($($expr),*;$($c),*;$($om),*))
        }
    };
}
macro_rules! dc {
    ($expr:expr ; $c:ident,$($c1:ident),*)=>{
        let $c=$expr;
    };
    ($expr:expr, $($expr1:expr),*; $c:ident,$($c1:ident),*)=>{
        let $c=$expr;
        dc!($($expr1),*;$($c1),*)
    };
}
macro_rules! co {
    ($expr:expr ; $c:ident,$($c1:ident),*; $op:expr,$($op1:expr),*)=>{
        $c*$op
    };
    ($expr:expr, $($expr1:expr),*; $c:ident,$($c1:ident),*; $o:expr,$($o1:expr),*)=>{
        $c*$o+co!($($expr1),*;$($c1),*;$($o1),*)
    };
}

fn eta_0_rec<T:FC64>(n: f64, coe_poly:&LOCoePoly<T>, a_1: Complex64, a_2: Complex64, a_3: Complex64, a_4: Complex64, a_5: Complex64) -> Complex64 {
  let (a,b,c,d)=(coe_poly.b/coe_poly.a,coe_poly.c/coe_poly.a,coe_poly.d/coe_poly.a,coe_poly.e/coe_poly.a);

    let a0 = (1. + a*(-1. + 3./(2.*n))) * a_1 + (a - b - (3.*(a - 2.*b))/(2.*n)) * a_2 + (b - c + (9.*c-6.*b)/(2.*n)) * a_3 + (c - d + (12.*d-9.*c)/(2.*n)) * a_4 + ((d*(-6./n + 1.0)))*a_5;
    a0
}
fn eta_0_vec_gen<T:FC64>(coe_poly:&LOCoePoly<T>,err:f64)->Vec<Complex64>{
  let a_1=-C1;
  let a0=eta_0_rec(1., coe_poly, a_1, C0, C0, C0, C0);
  let a1=eta_0_rec(2., coe_poly, a0, a_1, C0, C0, C0);
  let a2=eta_0_rec(3., coe_poly, a1, a0, a_1, C0, C0);
  let a3=eta_0_rec(4., coe_poly, a2, a1, a0, a_1, C0);
  let a4=eta_0_rec(5., coe_poly, a3, a2, a1, a0, a_1);
  let a5=eta_0_rec(6., coe_poly, a4, a3, a2, a1, a0);
  let mut eta_vec=vec![a0,a1,a2,a3,a4,a5];
  for n in 7..{
    let an=eta_0_rec(n as f64, coe_poly, eta_vec[n-2], eta_vec[n-3], eta_vec[n-4], eta_vec[n-5], eta_vec[n-6]);
    if (an*2.0_f64.powi(-(n as i32))).re.abs()<err&&(an*2.0_f64.powi(-(n as i32))).im.abs()<err{
      eta_vec.push(an);
      break;
    }
    eta_vec.push(an);
  }
  eta_vec
}
pub struct LOZero {
    range: f64,
    o:Complex64,
    eta: Vec<Complex64>,
    zi: Vec<Complex64>,
    zo: Vec<Complex64>,
}

struct LOCoePoly<T> {
    a: Complex64,
    b: Complex64,
    c: Complex64,
    d: Complex64,
    e: T,
}
trait New<T> {
    fn new(p:&Para<T>)->Self;
}
impl New<f64> for LOCoePoly<f64>{
  fn new(p:&Para<f64>)->Self{
    let k= p.kappa;
    let t=p.m*p.a;
    let s=p.s;
    let o=p.omega;
    let lamdo2=p.lambda/o/o;

    let a=-((2.*o+2.*k*o-I*k*(-1.+s)-t)*(2.*o+2.*k*o-I*k*(1.+s)-t)/(4.*k.powi(2)));
    let b=((4.*(1.+k).powi(2)-k*lamdo2)*o.powi(2)-s*(k+k*s-I*t)+2.*I*(1.+k)*o*((-1.+k)*s+I*t))/k;
    let c=(-4.*(1.+k)*(2.+k)+lamdo2)*o.powi(2)+s+s.powi(2)+2.*o*(-3.*I*k*s+t);
    let d=4.*k*o*(2.*(1.+k)*o+I*s);
    let e=-4.*k.powi(2)*o.powi(2);

    Self { a, b, c, d, e }
  }
}
impl New<Complex64> for LOCoePoly<Complex64>{
  fn new(p:&Para<Complex64>)->Self{
    let k= p.kappa;
    let t=p.m*p.a;
    let s=p.s;
    let o=p.omega;
    let lamdo2=p.lambda/o/o;

    let a=-((2.*o+2.*k*o-I*k*(-1.+s)-t)*(2.*o+2.*k*o-I*k*(1.+s)-t)/(4.*k.powi(2)));
    let b=((4.*(1.+k).powi(2)-k*lamdo2)*o.powi(2)-s*(k+k*s-I*t)+2.*I*(1.+k)*o*((-1.+k)*s+I*t))/k;
    let c=(-4.*(1.+k)*(2.+k)+lamdo2)*o.powi(2)+s+s.powi(2)+2.*o*(-3.*I*k*s+t);
    let d=4.*k*o*(2.*(1.+k)*o+I*s);
    let e=-4.*k.powi(2)*o.powi(2);

    Self { a, b, c, d, e }
  }
}
impl<T> LOCoePoly<T> 
where Self :New<T>
{
    fn new(p:&Para<T>)->Self{
        <Self as New<T>>::new(p)
    }
}
impl<T:FC64> LOCoePoly<T>{
  fn f(&self,x:f64)->Complex<f64>{
    (self.a + x*(self.b + x*(self.c + x*(self.e*x + self.d))))/((-1. + x)*x).powi(2)
  }
  fn dfdivf(&self,x:f64)->Complex<f64>{
    (2.*self.a + x*(-4.*self.a + self.b + x*(-3.*self.b + x*(-2.*self.c - self.d - (self.e*2. + self.d)*x))))/(2.*(x-1.)*x*(self.a + x*(self.b + x*(self.c + x*(self.e*x + self.d)))))
  }
}
fn on(o: Complex64, n: f64) -> Complex64 {
    (1. - 2. * o) / ((n + 1.) - 2. * o)
}
fn lo_zero_0(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    (C1, C1)
}
fn lo_zero_2(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(o, (-0.1875 - 0.140625 * a) * a + 0.1875 * b, (-0.1875 - 0.140625 * a) * a + 0.1875 * b)
}
fn lo_zero_3(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(o, a * (-0.15277777777777776 + (-0.02430555555555555 + 0.08159722222222222 * a) * a - 0.2569444444444444 * b) - 0.06944444444444445 * b + 0.2222222222222222 * c, a * (0.375 + (0.46875 + 0.140625 * a) * a - 0.1875 * b) - 0.375 * b, a * (-0.2222222222222222 + (-0.4444444444444444 - 0.2222222222222222 * a) * a + 0.4444444444444444 * b) + 0.4444444444444444 * b - 0.2222222222222222 * c)
}
fn lo_zero_4(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(
        o,
        (-0.06770833333333333 - 0.10839843750000001 * b) * b + a * (-0.13020833333333331 + a * (-0.012044270833333332 + (0.022298177083333332 - 0.052836100260416664 * a) * a + 0.22249348958333331 * b) - 0.048828125 * b - 0.25260416666666663 * c) - 0.03645833333333333 * c + 0.234375 * d,
        a * (0.5625 + a * (0.8730468749999999 + (0.39550781249999994 + 0.0428466796875 * a) * a + 0.0263671875 * b) - 0.33984375 * b) + (-0.5625 - 0.111328125 * b) * b,
        1.3333333333333333 * b + a * (-0.6666666666666666 + a * (-1.6666666666666665 + (-1.3333333333333333 - 0.3333333333333333 * a) * a + 0.6666666666666666 * b) + 2. * b - 0.3333333333333333 * c) - 0.6666666666666666 * c,
        (-0.703125 + 0.2197265625 * b) * b + a * (0.234375 + a * (0.8056640625 + (0.91552734375 + 0.34332275390625 * a) * a - 0.91552734375 * b) - 1.611328125 * b + 0.5859375 * c) + 0.703125 * c - 0.234375 * d
    )
}
fn lo_zero_5(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(
        o,
        b * (-0.06416666666666668 - 0.015260416666666667 * b - 0.20916666666666667 * c) - 0.03916666666666667 * c + a * (-0.11416666666666668 + (-0.034895833333333334 + 0.20153645833333333 * b) * b + a * (-0.004427083333333333 + a * (0.01947916666666667 + (-0.012581380208333336 + 0.038494466145833336 * a) * a - 0.19876302083333336 * b) + 0.050234375000000005 * b + 0.21833333333333335 * c) - 0.0475 * c - 0.25125000000000003 * d) - 0.022500000000000003 * d,
        b * (-0.75 - 0.2703125 * b - 0.08750000000000001 * c) + a * (0.75 + (-0.49687499999999996 - 0.047656250000000004 * b) * b + a * (1.3296875000000001 + a * (0.7562500000000001 + (0.14990234375 + 0.010693359375000001 * a) * a + 0.021484375 * b) + 0.06953125 * b + 0.065625 * c) + 0.08750000000000001 * c),
        a * (-1.3333333333333333 + (4.783333333333333 + 0.36666666666666664 * b) * b + a * (-3.816666666666667 + a * (-3.8291666666666666 + (-1.5416666666666667 - 0.19583333333333333 * a) * a + 0.20833333333333331 * b) + 2.325 * b - 0.19583333333333333 * c) - 1.15 * c) + b * (2.6666666666666665 + 0.36666666666666664 * b - 0.18333333333333332 * c) - 1.3333333333333333 * c,
        (-2.8125 + 0.87890625 * b) * b + 2.8125 * c + a * (0.9375 + (-7.8515625 + 0.439453125 * b) * b + 3.75 * c + a * (3.6914062500000004 + a * (5.2734375 + (3.204345703125 + 0.6866455078125 * a) * a - 1.8310546875 * b) - 6.884765625 * b + 1.171875 * c) - 0.46875 * d) - 0.9375 * d,
        b * (0.96 - 0.96 * b + 0.48 * c) - 1.44 * c + a * (-0.24 + (3.5999999999999996 - 0.96 * b) * b + a * (-1.2 + 4.4399999999999995 * b + a * (-2.2199999999999998 + (-1.7999999999999998 - 0.54 * a) * a + 1.7999999999999998 * b) - 1.26 * c) - 2.64 * c + 0.72 * d) + 0.96 * d
    )
}
fn lo_zero_6(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(
        o,
        (-0.03958333333333333 - 0.10050154320987655 * c) * c
            + b * (-0.06041666666666667 + (-0.01379002700617284 + 0.06078423394097223 * b) * b - 0.024361014660493827 * c - 0.20648871527777776 * d)
            + a * (-0.10208333333333333 + b * (-0.02490354938271605 + 0.034707001109182095 * b + 0.39531129436728396 * c) - 0.03609423225308642 * c + a * (0.0006920331790123456 + (0.045060673466435185 - 0.28015524781780476 * b) * b + a * (0.017445053288966048 + a * (-0.011117101598668981 + (0.008374805214964313 - 0.029985020484453364 * a) * a + 0.18409752551420236 * b) - 0.040672697844328705 * b - 0.1964159553433642 * c) + 0.045818262924382715 * c + 0.21684570312499998 * d) - 0.04698350694444444 * d)
            - 0.025694444444444443 * d,
        b * (-0.9375 + (-0.466796875 - 0.00347900390625 * b) * b - 0.208984375 * c - 0.076171875 * d)
            + a * (0.9375 + b * (-0.65625 - 0.17120361328125 * b - 0.0283203125 * c) + 0.208984375 * c + a * (1.826171875 + (0.15997314453125 - 0.0234222412109375 * b) * b + a * (1.20709228515625 + a * (0.3188629150390625 + (0.033092498779296875 - 0.0006380081176757812 * a) * a + 0.020374298095703125 * b) + 0.111785888671875 * b + 0.021240234374999997 * c) + 0.18505859375000003 * c + 0.05712890625 * d) + 0.076171875 * d),
        a * (-2.2222222222222223 + a * (-6.996913580246913 + (5.212962962962963 + 0.3734567901234568 * b) * b + a * (-8.119598765432098 + a * (-4.207175925925926 + (-0.9320987654320988 - 0.06983024691358024 * a) * a - 0.0470679012345679 * b) + 0.7060185185185185 * b - 0.2056327160493827 * c) - 1.064043209876543 * c) + b * (8.904320987654321 + 1.66358024691358 * b + 0.08487654320987653 * c) - 2.6882716049382713 * c)
            + b * (4.444444444444445 + 1.2901234567901234 * b - 0.3734567901234568 * c)
            + (-2.2222222222222223 - 0.13580246913580246 * c) * c,
        7.03125 * c
            + a * (2.34375 + b * (-22.1484375 + 0.25177001953125 * b + 0.62255859375 * c) + 12.1435546875 * c + a * (10.151367187499998 + (-23.89801025390625 - 0.5985260009765625 * b) * b + a * (16.75506591796875 + a * (12.987899780273438 + (4.627704620361328 + 0.584721565246582 * a) * a - 1.1944770812988281 * b) - 9.954071044921875 * b + 0.9979248046875001 * c) + 6.434326171875 * c - 0.399169921875 * d) - 2.0947265625 * d)
            + b * (-7.03125 + (1.4501953125 + 0.23345947265625 * b) * b + 0.7470703125 * c - 0.2490234375 * d)
            - 2.34375 * d,
        -7.199999999999999 * c + b * (4.8 - 4.8 * b + 2.4 * c) + 4.8 * d + a * (-1.2 - 16.8 * c + b * (20.4 - 7.199999999999999 * b + 1.2 * c) + 6. * d + a * (-6.6 + (31.200000000000003 - 2.4 * b) * b + a * (-14.1 + 20.099999999999998 * b + a * (-14.549999999999999 + (-7.199999999999999 - 1.3499999999999999 * a) * a + 4.5 * b) - 3.15 * c) - 12.9 * c + 1.7999999999999998 * d)),
        (2.4305555555555554 + 0.236304012345679 * c) * c
            + a * (0.24305555555555555 + b * (-6.474729938271604 + 5.421146345727237 * b - 2.27442611882716 * c) + 7.171826774691357 * c + a * (1.618682484567901 + b * (-12.719986527054397 + 2.9286466998818477 * b) + 7.29884018132716 * c + a * (4.239995509018132 + a * (5.461530332212095 + (3.4629268410765093 + 0.8657317102691273 * a) * a - 3.4629268410765093 * b) - 10.92306066442419 * b + 2.532883632330247 * c) - 1.6748046875 * d) - 3.934461805555556 * d)
            + b * (-1.2152777777777777 + (2.5402681327160495 - 0.2907647026909722 * b) * b - 2.5402681327160495 * c + 0.5316840277777778 * d)
            - 2.4305555555555554 * d
    )
}
fn lo_zero_7(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(
        o,
        c * (-0.039030612244897955 - 0.008621504157218442 * c - 0.1981292517006803 * d)
            + a * (-0.09260204081632653
                + (-0.0278494071239607 + 0.19381849962207104 * c) * c
                + a * (0.00431588955026455 + b * (0.04125607122189153 - 0.04764434837520077 * b - 0.5536356322042706 * c) + 0.040927476025132276 * c + a * (0.01585356212797619 + (-0.036244153911564624 + 0.3519431107132523 * b) * b + a * (-0.010152818560149754 + a * (0.007311868011636077 + (-0.006188004508851066 + 0.024375445163349083 * a) * a - 0.1737221183978691 * b) + 0.03562509526651372 * b + 0.18253691819609788 * c) - 0.03812959124622071 * c - 0.19557683620323127 * d) + 0.04394172512755102 * d)
                + b * (-0.017427248677248677 + (0.03237043754133598 - 0.17533862470769557 * b) * b + 0.06122945011337868 * c + 0.3925576636904762 * d)
                - 0.03655240221088435 * d)
            + b * (-0.056887755102040805 + b * (-0.012006743669690097 + 0.007014077115221088 * b + 0.17884566326530613 * c) - 0.02335996551398337 * c - 0.021653380102040817 * d)
            - 0.02712585034013605 * d,
        b * (-1.125 + b * (-0.6940848214285714 - 0.03007045200892857 * b + 0.004598214285714285 * c) - 0.35926339285714287 * c - 0.17845982142857142 * d)
            + a * (1.125
                + 0.35926339285714287 * c
                + b * (-0.8169642857142857 + (-0.3481480189732143 - 0.01963344029017857 * b) * b - 0.12035714285714286 * c - 0.01958705357142857 * d)
                + a * (2.354799107142857 + b * (0.2952406529017857 - 0.03184517996651786 * b - 0.02489397321428571 * c) + 0.3852064732142857 * c + a * (1.7368282645089286 + (0.25893833705357144 + 0.0226239013671875 * b) * b + a * (0.5514130510602678 + a * (0.07686248779296875 + (0.003955307006835937 + 0.0013944298880440849 * a) * a - 0.007783355712890624 * b) + 0.04483001708984375 * b + 0.016083984375 * c) + 0.10826450892857142 * c + 0.014690290178571428 * d) + 0.15343191964285716 * d)
                + 0.17845982142857142 * d),
        c * (-3.3333333333333335 - 0.4755291005291005 * c - 0.11309523809523811 * d)
            + a * (-3.3333333333333335
                + (-5.093915343915344 - 0.12466931216931218 * c) * c
                + a * (-11.285052910052912 + b * (9.474669312169313 + 1.7274636243386245 * b + 0.14815641534391535 * c) - 3.0536871693121697 * c + a * (-14.548065476190477 + (1.4332589285714286 + 0.16620370370370371 * b) * b + a * (-8.892104828042328 + a * (-2.6279875578703704 + (-0.34665798611111115 - 0.014429356812169314 * a) * a - 0.07232349537037037 * b) - 0.3366174768518519 * b - 0.1390986689814815 * c) - 1.0426669973544975 * c - 0.11309523809523811 * d) - 0.22619047619047622 * d)
                + b * (14.44378306878307 + (4.48057208994709 + 0.07232142857142858 * b) * b + 0.40168650793650795 * c + 0.22619047619047622 * d)
                - 0.11309523809523811 * d)
            + b * (6.666666666666667 + b * (2.9193121693121693 + 0.07232142857142858 * b - 0.03616071428571429 * c) - 0.5085978835978836 * c + 0.22619047619047622 * d),
        a * (4.6875
            + (29.044363839285715 + 0.44642857142857145 * c) * c
            + a * (21.82896205357143 + b * (-59.32277134486607 - 5.242374965122768 * b + 0.2772739955357143 * c) + 20.91831752232143 * c + a * (39.963291713169646 + (-30.94273158482143 - 1.3317108154296875 * b) * b + a * (36.29004342215402 + a * (16.90692901611328 + (3.7348270416259766 + 0.2991301672799247 * a) * a - 0.22649765014648438 * b) - 6.047630310058594 * b + 0.7720947265625 * c) + 6.32289341517857 * c - 0.20420619419642858 * d) - 2.005092075892857 * d)
            + b * (-48.236607142857146 + (-3.6281912667410716 + 0.36555698939732145 * b) * b + 2.7845982142857144 * c - 0.38992745535714285 * d)
            - 5.715680803571429 * d)
            + b * (-14.0625 + b * (0.9835379464285714 + 1.0659354073660714 * b + 0.1674107142857143 * c) + 2.8752790178571423 * c - 1.1369977678571428 * d)
            + c * (14.0625 + 0.5357142857142857 * c - 0.17857142857142858 * d)
            - 4.6875 * d,
        -21.6 * c
            + 14.4 * d
            + b * (14.4 + b * (-13.148571428571428 - 1.2514285714285716 * b + 0.6257142857142858 * c) + 5.322857142857143 * c + 1.2514285714285716 * d)
            + a * (-3.6 - 59.322857142857146 * c
                + b * (66.83571428571429 + (-22.85571428571429 - 1.2514285714285716 * b) * b + 3.132857142857143 * c + 0.9385714285714286 * d)
                + 23.94857142857143 * d
                + a * (-21.287142857142857 + b * (117.00428571428573 - 10.022142857142857 * b - 0.3117857142857143 * c) - 59.05071428571429 * c + 12.522857142857143 * d + a * (-50.401071428571434 + (94.89857142857143 - 0.315 * b) * b + a * (-60.73285714285715 + 34.61625 * b + a * (-38.908125000000005 + (-12.38625 - 1.4970535714285715 * a) * a + 4.28625 * b) - 3.493125 * c) - 24.576428571428572 * c + 1.9960714285714287 * d))),
        c * (14.583333333333334 + 1.417824074074074 * c) - 14.583333333333334 * d
            + b * (-7.291666666666667 + (15.241608796296296 - 1.7445882161458333 * b) * b - 15.241608796296296 * c + 3.1901041666666665 * d)
            + a * (1.4583333333333333
                + (50.322627314814824 + 0.708912037037037 * c) * c
                + a * (10.441261574074074 + b * (-95.74410897714121 + 33.8353192364728 * b - 6.823278356481481 * c) + 65.30852141203704 * c + a * (30.296020507812496 + b * (-103.69832356770833 + 8.785940099645543 * b) + 37.09382233796296 * c + a * (45.48916852032697 + a * (37.16215204309534 + a * (15.583170784844292 + 2.597195130807382 * a) - 10.388780523229528 * b) - 53.546743039731616 * b + 7.5986508969907405 * c) - 5.0244140625 * d) - 21.852213541666668 * d)
                - 30.8984375 * d
                + b * (-42.49421296296296 + (40.147682472511576 - 0.8722941080729166 * b) * b - 21.26736111111111 * c + 1.5950520833333333 * d)),
        b * (1.4693877551020407 + b * (-5.289795918367346 + 1.8808163265306121 * b - 0.9404081632653061 * c) + 7.93469387755102 * c - 3.330612244897959 * d)
            + c * (-3.673469387755102 - 1.4693877551020407 * c + 0.4897959183673469 * d)
            + 4.8979591836734695 * d
            + a * (-0.24489795918367346
                + (-15.281632653061223 - 1.2244897959183674 * c) * c
                + b * (10.285714285714285 + b * (-17.82857142857143 + 1.8808163265306121 * b) + 15.007346938775509 * c - 2.742857142857143 * d)
                + 12.63673469387755 * d
                + a * (-2.057142857142857 - 24.54857142857143 * c + b * (28.25142857142857 - 20.21877551020408 * b + 7.288163265306122 * c) + 11.363265306122448 * d + a * (-7.062857142857142 + (38.08653061224489 - 7.679999999999999 * b) * b + a * (-12.695510204081632 + 25.23428571428571 * b + a * (-12.617142857142856 + (-6.582857142857142 - 1.4106122448979592 * a) * a + 6.582857142857142 * b) - 4.937142857142857 * c) - 17.867755102040814 * c + 3.5265306122448976 * d)))
    )
}
fn lo_zero_8(a: Complex64, b: Complex64, c: Complex64, d: Complex64, o: Complex64) -> (Complex64, Complex64) {
    cpsez!(
        o,
        a * (-0.08493303571428573
            + a * (0.006977474475033069
                + (0.037502920968191966 - 0.2735104095620453 * c) * c
                + b * (0.03822843198423032 + (-0.04319096408823811 + 0.3361733528924367 * b) * b - 0.08822999419358671 * c - 0.5512663269042969 * d)
                + a * (0.014549300582320603 + b * (-0.033265073463399575 + 0.059381075510903006 * b + 0.6978503204022766 * c) - 0.03376596440713873 * c + a * (-0.009451164114412177 + (0.03134082940520433 - 0.4191699603310338 * b) * b + a * (0.006614082225416073 + a * (-0.005370178178504661 + (0.004857832890338999 - 0.020417670850991887 * a) * a + 0.1657702832531046 * b) - 0.03257567520494815 * b - 0.17256961645903413 * c) + 0.0339659285166907 * c + 0.1819807261512393 * d) - 0.03704840523856027 * d)
                + 0.038991655622209825 * d)
            + b * (-0.011653619998346562 + b * (0.03043646433996776 - 0.02355617402091859 * b - 0.5196894061376178 * c) + 0.05700860240472057 * c + 0.05777375720796132 * d)
            + c * (-0.021554258639219576 + 0.026586694465112436 * c + 0.384914318266369 * d)
            - 0.0291064453125 * d)
            + b * (-0.05368303571428572 + (-0.02140947937334656 + 0.17539984809027778 * c) * c + b * (-0.010307061735284392 + (0.007088821653335814 - 0.04110884666442871 * b) * b + 0.017460448249937997 * c + 0.17761993408203122 * d) - 0.02115536644345238 * d)
            + c * (-0.03805803571428572 - 0.008956305286871694 * c - 0.014145972842261906 * d)
            + (-0.02764136904761905 - 0.09759521484375 * d) * d,
        b * (-1.3125 + (-0.534375 + 0.0070149739583333336 * c) * c + b * (-0.9474609374999999 + (-0.08044352213541667 - 0.006569862365722656 * b) * b - 0.024803059895833333 * c + 0.0096435546875 * d) - 0.30390625000000004 * d)
            + a * (1.3125
                + (0.534375 - 0.0070149739583333336 * c) * c
                + b * (-0.978515625 + b * (-0.5743693033854166 - 0.03900456746419271 * b - 0.03607503255208334 * c) - 0.23629882812500003 * c - 0.097412109375 * d)
                + a * (2.9103515625000003
                    + (0.6618831380208334 - 0.00526123046875 * c) * c
                    + b * (0.4729142252604167 + (-0.05175905863444011 + 0.021426099141438802 * b) * b - 0.0011922200520833334 * c - 0.026623535156250003 * d)
                    + a * (2.3369767252604174 + b * (0.470898183186849 + 0.021622378031412762 * b + 0.03623331705729167 * c) + 0.2516959635416667 * c + a * (0.8472482935587565 + (0.10255756378173829 - 0.022425106366475423 * b) * b + a * (0.14515995025634768 + a * (0.011777431170145672 + (0.0007944862047831218 - 0.001071159988641739 * a) * a + 0.008966523011525472 * b) + 0.004132286707560222 * b - 0.006882781982421876 * c) + 0.03272511800130209 * c + 0.01454315185546875 * d) + 0.08521728515625 * d)
                    + 0.31569824218750003 * d)
                + 0.30390625000000004 * d),
        c * (-4.666666666666666 - 1.0768518518518517 * c - 0.39166666666666666 * d)
            + a * (-4.666666666666666
                + a * (-16.743518518518517
                    + (-6.625069444444444 - 0.06962962962962962 * c) * c
                    + a * (-23.411550925925926 + b * (2.302858796296296 + 0.7056597222222222 * b + 0.07919560185185184 * c) - 3.1178703703703703 * c + a * (-16.13689814814815 + (-1.1184346064814814 - 0.006435185185185185 * b) * b + a * (-5.75915943287037 + a * (-1.0398169849537036 + (-0.0864380787037037 - 0.003581452546296296 * a) * a - 0.01456741898148148 * b) - 0.34697193287037037 * b - 0.07321108217592592 * c) - 0.7653862847222221 * c - 0.09583333333333333 * d) - 0.5833333333333333 * d)
                    + b * (15.221296296296295 + (4.6799884259259255 + 0.09979166666666667 * b) * b + 0.6870717592592592 * c + 0.19166666666666665 * d)
                    - 0.8791666666666667 * d)
                + c * (-8.487037037037037 - 0.5468518518518518 * c - 0.09583333333333333 * d)
                + b * (21.46574074074074 + b * (9.343819444444444 + 0.4527083333333333 * b + 0.02677083333333333 * c) + 1.1368981481481482 * c + 0.9750000000000001 * d)
                - 0.39166666666666666 * d)
            + b * (9.333333333333332 + b * (5.375925925925926 + 0.35291666666666666 * b - 0.09979166666666667 * c) + (-0.5342592592592592 - 0.03833333333333333 * c) * c + 0.7833333333333333 * d),
        a * (8.203125
            + a * (40.4803466796875
                + (51.77955627441406 + 0.658416748046875 * c) * c
                + b * (-121.5825653076172 + (-21.277403831481934 - 0.06133317947387695 * b) * b + 0.9534835815429689 * c - 0.8558273315429686 * d)
                + a * (80.26512145996094 + b * (-73.02397727966309 - 8.534300327301025 * b - 0.3018379211425781 * c) + 22.513809204101562 * c + a * (81.7635703086853 + (-17.912142276763916 - 0.9453281760215759 * b) * b + a * (45.420215129852295 + a * (13.479198515415192 + (1.940000802278519 + 0.10201125405728817 * a) * a + 0.15391036868095398 * b) - 0.8146077394485474 * b + 0.5598902702331543 * c) + 5.279736518859863 * c + 0.14225482940673828 * d) - 0.5736160278320312 * d)
                - 5.5046844482421875 * d)
            + b * (-90.079345703125 + b * (-16.244125366210938 + 1.3170719146728516 * b + 0.4606246948242188 * c) + 7.603607177734375 * c - 3.026275634765625 * d)
            + c * (58.170166015625 + 2.8302001953125 * c + 0.0982666015625 * d)
            - 12.137451171875 * d)
            + b * (-24.609375 + 7.042236328125 * c + b * (-1.7999267578124998 + (2.7092742919921875 + 0.08014440536499023 * b) * b + 1.0214996337890625 * c + 0.0501251220703125 * d) - 3.597412109375 * d)
            + c * (24.609375 + 2.4481201171875 * c - 0.382080078125 * d)
            + (-8.203125 - 0.1446533203125 * d) * d,
        c * (-50.4 - 1.32 * c + 0.88 * d)
            + 33.6 * d
            + b * (33.6 + (7.18 + 0.44 * c) * c + b * (-26.6 - 7. * b + 2.6199999999999997 * c) + 7. * d)
            + a * (-8.4
                + c * (-156.4 - 2.42 * c + 0.66 * d)
                + 67.72 * d
                + b * (166.77 + b * (-47.25 - 9.620000000000001 * b + 0.43 * c) + 1.3800000000000001 * c + 7.87 * d)
                + a * (-52.63 + (-186.145 - 1.155 * c) * c + 47.9 * d + b * (321.455 + (-16.330000000000002 - 2.6199999999999997 * b) * b - 4.3175 * c + 1.965 * d) + a * (-134.8525 + b * (302.02500000000003 + 7.4375 * b - 0.89125 * c) - 104.5625 * c + 13.8025 * d + a * (-181.78875 + b * (141.31875 + 3.1175 * b) + a * (-137.891875 + 29.470625000000002 * b + a * (-58.0871875 + (-12.37125 - 1.0096875 * a) * a + 1.891875 * b) - 2.8509375 * c) - 27.599375000000002 * c + 1.34625 * d)))),
        c * (51.041666666666664 + 4.9623842592592595 * c) - 51.041666666666664 * d
            + b * (-25.520833333333332 + (-49.58586516203704 + 0.3655327690972222 * c) * c + b * (51.46574797453704 + (-2.1765814887152777 - 0.44977664947509766 * b) * b - 3.929477267795139 * c + 0.82244873046875 * d) + 7.405598958333334 * d)
            + a * (5.104166666666667
                + c * (197.8902633101852 + 4.596851490162037 * c)
                + a * (38.720522280092595
                    + (302.73067898220484 + 0.9664464879918981 * c) * c
                    + a * (121.5223976417824 + b * (-496.7496525799786 + 62.246362368265785 * b - 5.383993078161169 * c) + 224.5074575918692 * c + a * (203.79345805556684 + b * (-328.78358081535055 + 6.620992444179676 * b) + 79.1236178080241 * c + a * (196.306215039006 + a * (107.8819203156012 + a * (31.004016874013125 + 3.5407074244210013 * a) - 12.82365095836145 * b) - 106.68164513729236 * b + 10.359098293163159 * c) - 6.849689483642578 * d) - 48.67151896158854 * d)
                    + b * (-395.5398446542245 + b * (157.67288879111962 + 3.341068161858453 * b) - 43.34360193323206 * c - 0.4162089029947917 * d)
                    - 121.64906819661456 * d)
                - 129.90559895833334 * d
                + b * (-159.23430266203704 + b * (153.24462890625 + 2.729553646511502 * b - 3.518252902560764 * c) - 86.08518247251158 * c + 4.256795247395833 * d)),
        b * (10.285714285714285 + b * (-37.02857142857143 + 13.165714285714287 * b - 6.582857142857144 * c) + 55.54285714285714 * c - 23.314285714285717 * d)
            + 34.285714285714285 * d
            + c * (-25.714285714285715 - 10.285714285714285 * c + 3.428571428571429 * d)
            + a * (-1.7142857142857144
                + b * (77.14285714285715 + b * (-143.31428571428572 + 19.74857142857143 * b - 3.291428571428572 * c) + 132.82285714285715 * c - 30.857142857142858 * d)
                + 105.60000000000001 * d
                + c * (-119.82857142857144 - 13.714285714285715 * c + 1.7142857142857144 * d)
                + a * (-15.257142857142858
                    + (-225.3257142857143 - 4.285714285714286 * c) * c
                    + b * (233.76000000000002 + b * (-203.93142857142857 + 6.582857142857144 * b) + 103.54285714285714 * c - 9.6 * d)
                    + 123.77142857142857 * d
                    + a * (-56.64 - 210.99428571428572 * c + b * (365.4857142857143 - 124.52571428571427 * b + 25.50857142857143 * c) + 64.45714285714286 * d + a * (-113.58857142857143 + (309.9428571428572 - 26.880000000000003 * b) * b + a * (-132.75428571428571 + 134.4 * b + a * (-90.24000000000001 + (-32.91428571428572 - 4.937142857142858 * a) * a + 23.040000000000003 * b) - 17.28 * c) - 97.09714285714286 * c + 12.342857142857145 * d)))),
        c * (5.16796875 + 5.281018066406249 * c - 3.5206787109375006 * d)
            + (-8.61328125 + 0.24224853515625 * d) * d
            + b * (-1.72265625 + (-19.0891845703125 - 0.9496142578125 * c) * c + b * (9.54459228515625 + (-6.977969055175781 + 0.4173109531402588 * b) * b + 6.977969055175781 * c - 1.0598373413085938 * d) + 12.047827148437499 * d)
            + a * (0.24609375 + c * (28.142358398437505 + 9.23451416015625 * c - 2.76163330078125 * d) - 31.1600830078125 * d
                + b * (-15.0747802734375 - 56.678889770507816 * c + b * (44.763895568847666 - 14.565344581604004 * b + 6.448050384521484 * c) + 20.821261596679687 * d)
                + a * (2.51246337890625
                    + c * (62.88616241455078 + 4.1642523193359375 * c)
                    + a * (10.765005798339844 + b * (-100.47757633209228 + 62.58948906898499 * b - 19.744769668579103 * c) + 71.43545928955078 * c + a * (25.11939408302307 + b * (-103.58134783744812 + 18.534865983724593 * b) + 40.99185876846313 * c + a * (34.52711594581604 + a * (27.999478400945662 + a * (12.422303797602654 + 2.3291819620504977 * a) - 12.422303797602654 * b) - 55.998956801891325 * b + 9.464612417221069 * c) - 7.082363033294677 * d) - 28.47934341430664 * d)
                    - 43.99319915771485 * d
                    + b * (-53.82502899169922 + (79.28090520858763 - 7.699983243942261 * b) * b - 57.43288833618164 * c + 9.293259429931641 * d)))
    )
}

impl LOZero{
  fn new<T:FC64>(coe_poly:&LOCoePoly<T>,err:f64)->Self{
    let mut zi=vec![C1,C0];
    let mut zo=vec![C1,C0];

    let (a,b,c,d)=(coe_poly.b/coe_poly.a,coe_poly.c/coe_poly.a,coe_poly.d/coe_poly.a,coe_poly.e/coe_poly.a);

    let o=0.5*(1. + (1. + 4.*coe_poly.a).sqrt());

    let c2=lo_zero_2(a, b, c, d, o);
    zi.push(c2.0);
    zo.push(c2.1);

    let c3=lo_zero_3(a, b, c, d, o);
    zi.push(c3.0);
    zo.push(c3.1);

    let c4=lo_zero_4(a, b, c, d, o);
    zi.push(c4.0);
    zo.push(c4.1);

    let c5=lo_zero_5(a, b, c, d, o);
    zi.push(c5.0);
    zo.push(c5.1);

    let c6=lo_zero_6(a, b, c, d, o);
    zi.push(c6.0);
    zo.push(c6.1);

    let c7=lo_zero_7(a, b, c, d, o);
    zi.push(c7.0);
    zo.push(c7.1);

    let c8=lo_zero_8(a, b, c, d, o);
    zi.push(c8.0);
    zo.push(c8.1);

    let eta=eta_0_vec_gen(coe_poly, err);

    let range=(err/c8.0.abs().max(c8.1.abs())).powf(1.0/8.0);

    Self { range, o, eta, zi, zo }
  }
  fn cal<T:FC64>(&self,p:&LOCoePoly<T>,x:f64)->(Res<Complex64>,Res<Complex64>){
    let exp=self.eta.res(x).0.exp();
    let zi=self.zi.res(x);
    let zo=self.zo.res(x);
    let tf=p.f(x)/p.a;
    let dfdivf=p.dfdivf(x);

    let head=Res(
      exp.powc(self.o)/(exp*tf.sqrt()).sqrt(),
      exp.powc(self.o)/(exp*tf.sqrt()).sqrt()*(self.o-0.5)*(tf.sqrt()-dfdivf/4.)
    );

    (head*zi,head*zo)
  }
}

#[test]
fn consist_check() {
    let s=-2.;
    let m=2.;
    let a=0.9999;
    let lambda=-39.49509246929860904443313772302516584073520275064;
    let omega=7.1;

    let p=Para::new(s, m, a, omega, lambda);
    let lop=LOCoePoly::new(&p);

    let loz=LOZero::new(&lop, 1e-15);
    let zi=ZeroIn::new(&p, 20, 1e-15);
    let zo=ZeroOut::new(&p, 20, 1e-15);
    let range=loz.range.min(zi.range);

    let a=loz.cal(&lop, -range);

    println!("{:?}",a)
}
